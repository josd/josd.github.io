<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LLDM — ARC style (self‑contained)</title>
  <style>
    :root{
      --bg:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --panel:#f8fafc;
      --border:#e5e7eb;
      --accent:#0ea5e9;
      --good:#16a34a;
      --warn:#dc2626;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --ui: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    html,body{height:100%}
    body{ margin:0; background:var(--bg); color:var(--ink); font:15px/1.5 var(--ui); }
    .wrap{max-width:980px; margin:36px auto; padding:0 16px;}
    header{display:flex; align-items:center; justify-content:space-between; margin-bottom:16px}
    h1{font-size:22px; margin:0; letter-spacing:.2px}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted); background:#fff}
    .row{display:flex; flex-direction:column; gap:16px}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:14px; overflow:hidden}
    .head{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--border)}
    .head h2{font-size:13px; text-transform:uppercase; letter-spacing:.08em; color:var(--muted); margin:0}
    .body{padding:12px}
    input[type="number"]{width:120px; padding:8px; border:1px solid var(--border); border-radius:10px; font:14px var(--ui)}
    pre{white-space:pre-wrap; background:#fff; border:1px solid var(--border); border-radius:10px; padding:12px; overflow:auto; font-family:var(--mono); font-size:13px}
    .bar{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; align-items:center}
    button{all:unset; background:#fff; border:1px solid var(--border); padding:8px 12px; border-radius:10px; cursor:pointer}
    button:hover{border-color:#cbd5e1}
    .small{color:var(--muted); text-decoration:none}
    .accent{color:var(--accent)}
    .hr{height:1px; background:var(--border); margin:10px 0}
    /* ARC Cards */
    .arc-grid{display:flex; flex-direction:column; gap:12px}
    .arc-card{background:#fff; border:1px solid var(--border); border-radius:14px; overflow:hidden}
    .arc-card .ac-head{display:flex; align-items:center; gap:8px; padding:10px 12px; border-bottom:1px solid var(--border); font-size:12px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted)}
    .arc-card .ac-body{padding:12px}
    .arc-card pre{margin:0; white-space:pre-wrap; background:#fff; border:1px solid #eef2f7; border-radius:10px; padding:10px; font-family:var(--mono); font-size:13px}
    .arc-card.answer{border-left:4px solid #10b981}
    .arc-card.reason{border-left:4px solid #3b82f6}
    .arc-card.check{border-left:4px solid #f59e0b}
    .toolbar{display:flex; gap:8px; align-items:center}
    .grid2{display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:8px}
    label{font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>LLDM — <span class="accent">ARC</span> (Answer • Reason • Check)</h1>
      <div class="pill" id="statusPill">Ready</div>
    </header>

    <div class="card" style="margin-bottom:16px">
      <div class="body">
        <p><strong>What this is?</strong> A self‑contained, browser‑only harness for the Line–Line Distance Method (LLDM)
        used to estimate lower‑limb discrepancy from four anatomical landmarks. Enter the four points (<code>p1..p4</code>),
        click <em>Run</em>, and view the trace plus an ARC report (<em>Answer • Reason • Check</em>).</p>
        <p class="small">This page is for reproducibility and documentation only.</p>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <div class="head"><h2>Input — Four points (cm)</h2></div>
        <div class="body">
          <div class="grid2">
            <div>
              <label>p1x</label>
              <input id="p1x" type="number" step="0.1" value="10.1">
            </div>
            <div>
              <label>p1y</label>
              <input id="p1y" type="number" step="0.1" value="7.8">
            </div>
            <div>
              <label>p2x</label>
              <input id="p2x" type="number" step="0.1" value="45.1">
            </div>
            <div>
              <label>p2y</label>
              <input id="p2y" type="number" step="0.1" value="5.6">
            </div>
            <div>
              <label>p3x</label>
              <input id="p3x" type="number" step="0.1" value="3.6">
            </div>
            <div>
              <label>p3y</label>
              <input id="p3y" type="number" step="0.1" value="29.8">
            </div>
            <div>
              <label>p4x</label>
              <input id="p4x" type="number" step="0.1" value="54.7">
            </div>
            <div>
              <label>p4y</label>
              <input id="p4y" type="number" step="0.1" value="28.5">
            </div>
          </div>
          <div class="bar">
            <button onclick="run()">▶ Run</button>
            <span class="small">Alarm threshold: |dCm| &gt; 1.25</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="head"><h2>Trace (steps)</h2></div>
        <div class="body">
          <pre id="trace_pre">(no run yet)</pre>
        </div>
      </div>

      <div class="card">
        <div class="head">
          <h2>ARC Output</h2>
          <div class="toolbar">
            <button onclick="toggleArcStyle()" id="styleBtn">Style: Cards</button>
            <button onclick="downloadARC()">⬇ Export .txt</button>
            <a class="small" href="#" onclick="copyOutput();return false;">Copy</a>
          </div>
        </div>
        <div class="body">
          <div id="arc-cards" class="arc-grid">
            <div class="arc-card answer">
              <div class="ac-head">Answer</div>
              <div class="ac-body"><pre id="arc_ans">(no run yet)</pre></div>
            </div>
            <div class="arc-card reason">
              <div class="ac-head">Reason why</div>
              <div class="ac-body"><pre id="arc_reason">(no run yet)</pre></div>
            </div>
            <div class="arc-card check">
              <div class="ac-head">Check (harness)</div>
              <div class="ac-body"><pre id="arc_check">(no run yet)</pre></div>
            </div>
          </div>
          <pre id="arc" style="display:none">(no run yet)</pre>
        </div>
      </div>
    </div>
  </div>

<script>
function f(x, n=4){ return Number.isFinite(x) ? x.toFixed(n) : String(x); }
function s(x, n=4){
  const v = Number(x);
  const sign = (v<0 ? '−' : '+'); // U+2212 minus for readability
  return sign + f(Math.abs(v), n);
}
function s6(x){ return s(x, 6); }
function f6(x){ return f(x, 6); }

function calc(){
  const p1x=+document.getElementById('p1x').value;
  const p1y=+document.getElementById('p1y').value;
  const p2x=+document.getElementById('p2x').value;
  const p2y=+document.getElementById('p2y').value;
  const p3x=+document.getElementById('p3x').value;
  const p3y=+document.getElementById('p3y').value;
  const p4x=+document.getElementById('p4x').value;
  const p4y=+document.getElementById('p4y').value;

  const dx12 = p1x - p2x;
  const dy12 = p1y - p2y;
  const dy13 = p1y - p3y;
  const dy24 = p2y - p4y;

  const cL1  = dy12 / dx12;
  const dL3m = -1 / cL1;
  const cL3  = -dL3m;

  const pL1x1 = cL1 * p1x;
  const pL1x2 = cL1 * p2x;
  const pL3x3 = cL3 * p3x;
  const pL3x4 = cL3 * p4x;

  const dd13  = pL1x1 - pL3x3;
  const ddy13 = dd13 - dy13;
  const dd24  = pL1x2 - pL3x4;
  const ddy24 = dd24 - dy24;

  const ddL13 = cL1 - cL3;

  const p5x = ddy13 / ddL13;
  const dx51 = p5x - p1x;
  const p5y = cL1 * dx51 + p1y;

  const p6x = ddy24 / ddL13;
  const dx62 = p6x - p2x;
  const p6y = cL1 * dx62 + p2y;

  const dx53 = p5x - p3x;
  const dx64 = p6x - p4x;
  const dy53 = p5y - p3y;
  const dy64 = p6y - p4y;

  const d53sq = dx53*dx53 + dy53*dy53;
  const d64sq = dx64*dx64 + dy64*dy64;

  const d53 = Math.sqrt(d53sq);
  const d64 = Math.sqrt(d64sq);
  const d   = d53 - d64;
  const alarm = Math.abs(d) > 1.25 ? 1 : 0;

  return {p1x,p1y,p2x,p2y,p3x,p3y,p4x,p4y,
    dx12,dy12,dy13,dy24,cL1,dL3m,cL3,pL1x1,pL1x2,pL3x3,pL3x4,dd13,ddy13,dd24,ddy24,ddL13,p5x,dx51,p5y,p6x,dx62,p6y,dx53,dx64,dy53,dy64,d53sq,d64sq,d53,d64,d,alarm};
}

function buildTrace(t){
  const sep = '────────────────────────────────────────────────────────────────────────────';
  let L = [];
  L.push(`Step 01 dx12Cm = p1x – p2x = ${f(t.p1x)} – ${f(t.p2x)} = ${s(t.dx12)} cm`);
  L.push(`Step 02 dy12Cm = p1y – p2y = ${f(t.p1y)} – ${f(t.p2y)} = ${s(t.dy12)} cm`);
  L.push(`Step 03 dy13Cm = p1y – p3y = ${f(t.p1y)} – ${f(t.p3y)} = ${s(t.dy13)} cm`);
  L.push(`Step 04 dy24Cm = p2y – p4y = ${f(t.p2y)} – ${f(t.p4y)} = ${s(t.dy24)} cm`);
  L.push(sep);
  L.push(`Step 05 cL1 = slope of L1 = dy12 / dx12 = ${s(t.dy12,4).replace('+','+').replace('−','−')} / ${s(t.dx12,4)} = ${s6(t.cL1)}`);
  L.push(`Step 06 dL3m = −1 / cL1 = −1 / ${s6(t.cL1)} = ${s6(t.dL3m)}`);
  L.push(`Step 07 cL3 = −dL3m = −(${f6(t.dL3m)}) = ${s6(t.cL3)}`);
  L.push(sep);
  L.push(`Step 08 pL1x1 = cL1 · p1x = ${f6(t.cL1)} · ${f(t.p1x)} = ${s(t.pL1x1)} cm`);
  L.push(`Step 09 pL1x2 = cL1 · p2x = ${f6(t.cL1)} · ${f(t.p2x)} = ${s(t.pL1x2)} cm`);
  L.push(`Step 10 pL3x3 = cL3 · p3x = ${f6(t.cL3)} · ${f(t.p3x)} = ${s(t.pL3x3)} cm`);
  L.push(`Step 11 pL3x4 = cL3 · p4x = ${f6(t.cL3)} · ${f(t.p4x)} = ${s(t.pL3x4)} cm`);
  L.push(sep);
  L.push(`Step 12 dd13Cm = pL1x1 – pL3x3 = ${s(t.pL1x1)} – ${s(t.pL3x3)} = ${s(t.dd13)} cm`);
  L.push(`Step 13 ddy13Cm = dd13Cm – dy13Cm = ${s(t.dd13)} – (${s(t.dy13)}) = ${s(t.ddy13)} cm`);
  L.push(`Step 14 dd24Cm = pL1x2 – pL3x4 = ${s(t.pL1x2)} – ${s(t.pL3x4)} = ${s(t.dd24)} cm`);
  L.push(`Step 15 ddy24Cm = dd24Cm – dy24Cm = ${s(t.dd24)} – (${s(t.dy24)}) = ${s(t.ddy24)} cm`);
  L.push(sep);
  L.push(`Step 16 ddL13 = cL1 – cL3 = ${s6(t.cL1)} – ${s6(t.cL3)} = ${s6(t.ddL13)}`);
  L.push(`Step 17 p5xCm = ddy13Cm / ddL13 = ${s(t.ddy13)} / ${s6(t.ddL13)} = ${s(t.p5x)} cm`);
  L.push(`Step 18 dx51Cm = p5x – p1x = ${t.p5x} – ${t.p1x} = ${s(t.dx51)} cm`);
  L.push(`Step 19 p5yCm = cL1·dx51 + p1y = (${s6(t.cL1)})(${s(t.dx51)}) + ${f(t.p1y)} = ${s(t.p5y)} cm`);
  L.push(`Step 20 p6xCm = ddy24Cm / ddL13 = ${s(t.ddy24)} / ${s6(t.ddL13)} = ${s(t.p6x)} cm`);
  L.push(`Step 21 dx62Cm = p6x – p2x = ${t.p6x} – ${t.p2x} = ${s(t.dx62)} cm`);
  L.push(`Step 22 p6yCm = cL1·dx62 + p2y = (${s6(t.cL1)})(${s(t.dx62)}) + ${f(t.p2y)} = ${s(t.p6y)} cm`);
  L.push(sep);
  L.push(`Step 23 dx53Cm = p5x – p3x = ${t.p5x} – ${t.p3x} = ${s(t.dx53)} cm`);
  L.push(`Step 24 dx64Cm = p6x – p4x = ${t.p6x} – ${t.p4x} = ${s(t.dx64)} cm`);
  L.push(`Step 25 dy53Cm = p5y – p3y = ${t.p5y} – ${t.p3y} = ${s(t.dy53)} cm`);
  L.push(`Step 26 dy64Cm = p6y – p4y = ${t.p6y} – ${t.p4y} = ${s(t.dy64)} cm`);
  L.push(sep);
  const dx53sq = f(t.dx53*t.dx53,3);
  const dy53sq = f(t.dy53*t.dy53,3);
  const d53sum = f(t.d53sq,3);
  const dx64sq = f(t.dx64*t.dx64,3);
  const dy64sq = f(t.dy64*t.dy64,3);
  const d64sum = f(t.d64sq,3);
  L.push(`Step 27 d53Cm = √(dx53² + dy53²) = √(${s(t.dx53)}² + ${s(t.dy53)}²) = √(${dx53sq} + ${dy53sq}) = √${d53sum} = ${s(t.d53)} cm`);
  L.push(`Step 28 d64Cm = √(dx64² + dy64²) = √(${s(t.dx64)}² + ${s(t.dy64)}²) = √(${dx64sq} + ${dy64sq}) = √${d64sum} = ${s(t.d64)} cm`);
  L.push(`Step 29 dCm = d53 – d64 = ${f(t.d53)} – ${f(t.d64)} = ${s(t.d)} cm`);
  L.push(`Step 30 LLDAlarm = |dCm| > 1.25 ? = |${s(t.d)}| > 1.25 → ${Math.abs(t.d)>1.25 ? 'True' : 'False'} = ${f(t.alarm,6)}`);
  return L.join('\n');
}

function buildARC(t){
  let txt = '';
  txt += "============================================\n";
  txt += "LLDM — Answer / Reason why / Check (harness)\n";
  txt += "============================================\n\n";
  txt += "Answer\n======\n";
  txt += `dCm = ${s(t.d)} cm; threshold = 1.25 cm\n`;
  txt += `LLDAlarm = ${Math.abs(t.d)>1.25 ? 'True (1)' : 'False (0)'}\n\n`;

  txt += "Reason why\n==========\n";
  txt += `• Two baseline lines are formed: L1 through (p1,p2) and L3 perpendicular to L1.\n`;
  txt += `• Foot points (p5 on L1 w.r.t p3, p6 on L1 w.r.t p4) are computed by slope algebra.\n`;
  txt += `• Distances d53 and d64 are Euclidean; the discrepancy is dCm = d53 − d64.\n`;
  txt += `• Alarm if |dCm| > 1.25 cm.\n\n`;

  txt += "Check (harness)\n===============\n";
  txt += `• ddL13 ≠ 0 (well-defined foot points): ${Math.abs(t.ddL13)>1e-9 ? '✓' : '✗'}\n`;
  txt += `• Recompute distances from components matches totals: ` +
         `${Math.abs(Math.sqrt(t.dx53*t.dx53+t.dy53*t.dy53)-t.d53)<1e-9 && Math.abs(Math.sqrt(t.dx64*t.dx64+t.dy64*t.dy64)-t.d64)<1e-9 ? '✓' : '✗'}\n`;
  return txt;
}

function run(){
  const t = calc();
  const trace = buildTrace(t);
  document.getElementById('trace_pre').textContent = trace;
  const arc = buildARC(t);
  document.getElementById('arc').textContent = arc;
  updateArcCards();
  document.getElementById('statusPill').textContent = `Computed • dCm ${s(t.d)} cm • Alarm ${t.alarm}`;
}

// ARC helpers
function toggleArcStyle(){
  const pre = document.getElementById('arc');
  const cards = document.getElementById('arc-cards');
  const btn = document.getElementById('styleBtn');
  const showingCards = cards.style.display !== 'none';
  if(showingCards){
    cards.style.display = 'none';
    pre.style.display = 'block';
    btn.textContent = 'Style: Plain';
  }else{
    cards.style.display = 'block';
    pre.style.display = 'none';
    btn.textContent = 'Style: Cards';
  }
}
function updateArcCards(){
  const txt = document.getElementById('arc').textContent || "";
  const answer  = (txt.match(/^\s*Answer\s*\n=+\n([\s\S]*?)\n(?=Reason why\s*\n=+)/m) || [,""])[1].trim();
  const reason  = (txt.match(/^\s*Reason why\s*\n=+\n([\s\S]*?)\n(?=Check\s+\(harness\)\s*\n=+)/m) || [,""])[1].trim();
  const check   = (txt.match(/^\s*Check\s+\(harness\)\s*\n=+\n([\s\S]*)$/m) || [,""])[1].trim();
  document.getElementById('arc_ans').textContent    = answer || '(no run yet)';
  document.getElementById('arc_reason').textContent = reason || '(no run yet)';
  document.getElementById('arc_check').textContent  = check  || '(no run yet)';
}
function copyOutput(){ const el=document.getElementById('arc'); const r=document.createRange(); r.selectNodeContents(el); const s=window.getSelection(); s.removeAllRanges(); s.addRange(r); document.execCommand('copy'); s.removeAllRanges(); }
function downloadARC(){ const blob=new Blob([document.getElementById('arc').textContent],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='lldm_output.txt'; document.body.appendChild(a); a.click(); a.remove(); }

// Bootstrap
run();
</script>
</body>
</html>
